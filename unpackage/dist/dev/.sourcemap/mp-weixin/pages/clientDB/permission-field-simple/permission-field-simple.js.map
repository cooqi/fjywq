{"version":3,"file":"permission-field-simple.js","sources":["pages/clientDB/permission-field-simple/permission-field-simple.vue","D:/ruanjian/HBuilderX.3.6.18.20230117/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2xpZW50REIvcGVybWlzc2lvbi1maWVsZC1zaW1wbGUvcGVybWlzc2lvbi1maWVsZC1zaW1wbGUudnVl"],"sourcesContent":["<template>\r\n\t<view class=\"page\">\r\n\t\t<view class=\"top-view\">\r\n\t\t\t<uniNoticeBar showIcon=\"true\" iconType=\"info\" text=\"管理员(admin)拥有任何权限,权限控制对其无效。\"></uniNoticeBar>\r\n\t\t\t<uni-segmented-control @clickItem=\"typeIndex = $event.currentIndex\" :values=\"types.map(({text})=>text)\"></uni-segmented-control>\r\n\t\t</view>\r\n\t\t<alertCode ref=\"alertCode\"></alertCode>\r\n\t\t<template v-for=\"(item,index) in permissionList\">\r\n\t\t\t<view class=\"item\"  v-if=\"item.exclude !== type\">\r\n\t\t\t\t<view class=\"msg\">{{item.msg}}</view>\r\n\t\t\t\t<text style=\"color: #999999;\">schema路径：uniCloud/database/permission-test-{{index+10}}.schema.json\\n</text>\r\n\t\t\t\t<view class=\"code\">\r\n\t\t\t\t\t配置规则\r\n\t\t\t\t\t<scroll-view scroll-x class=\"code-box\">\r\n\t\t\t\t\t\t<show-code :codes=\"item.codes[type]\"></show-code>\r\n\t\t\t\t\t</scroll-view>\r\n\t\t\t\t\t<text>含义解释：{{item.explain}}</text>\r\n\t\t\t\t\t<text>【{{typeText}}】</text>\r\n\t\t\t\t\t<text>{{item.explain_end}}</text>\r\n\t\t\t\t</view>\r\n\t\t\t\r\n\t\t\t\t<button type=\"primary\" size=\"mini\" plain @click=\"myFn({type,index})\">\r\n\t\t\t\t\t{{typeText}}\r\n\t\t\t\t\t<text v-if=\"type!='create'\">记录全部字段</text>\r\n\t\t\t\t\t<text v-else>一条记录</text>\r\n\t\t\t\t</button>\r\n\t\t\t\t<template v-if=\"[0,1,2].includes(index)\">\r\n\t\t\t\t\t<button type=\"primary\" size=\"mini\" @click=\"myFn({type,index,field:'_id,state,create_time,text'})\">{{typeText}}不含字段{{item.field}}的记录</button>\r\n\t\t\t\t</template>\r\n\t\t\t</view>\r\n\t\t</template>\r\n\t\t<set-permission @change=\"changePermission\"></set-permission>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\tconst db = uniCloud.database()\r\n\timport alertCode from '@/components/alertCode/alertCode.vue';\r\n\timport uniNoticeBar from '@/uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.vue'\r\n\texport default {\r\n\t\tcomponents: {\r\n\t\t\tuniNoticeBar,alertCode\r\n\t\t},\r\n\t\tcomputed: {\r\n\t\t\ttype() {\r\n\t\t\t\treturn this.types[this.typeIndex].value\r\n\t\t\t},\r\n\t\t\ttypeText() {\r\n\t\t\t\treturn this.types[this.typeIndex].text\r\n\t\t\t}\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tcurrentRole:0,\r\n\t\t\t\ttypes: [{\r\n\t\t\t\t\t\ttext: \"创建\",\r\n\t\t\t\t\t\tvalue: \"create\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttext: \"读取\",\r\n\t\t\t\t\t\tvalue: \"read\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttext: \"更新\",\r\n\t\t\t\t\t\tvalue: \"update\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t/* {\r\n\t\t\t\t\t\ttext: \"删除\",\r\n\t\t\t\t\t\tvalue: \"delete\"\r\n\t\t\t\t\t} */\r\n\t\t\t\t],\r\n\t\t\t\ttypeIndex: 0,\r\n\t\t\t\tpermissionList: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"msg\": \"直接禁止\",\r\n\t\t\t\t\t\t\"field\":\"ip\",\r\n\t\t\t\t\t\t\"code\": false,\r\n\t\t\t\t\t\t\"explain\": \"禁止任何角色\",\r\n\t\t\t\t\t\t\"explain_end\": \"含字段ip的记录，管理员角色除外\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"msg\": \"需要登陆\",\r\n\t\t\t\t\t\t\"field\":\"ip\",\r\n\t\t\t\t\t\t\"code\": \"auth.uid != null\",\r\n\t\t\t\t\t\t\"explain\": \"禁止未登陆的游客\",\r\n\t\t\t\t\t\t\"explain_end\": \"含字段ip的记录\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"msg\": \"指定角色\",\r\n\t\t\t\t\t\t\"field\":\"ip\",\r\n\t\t\t\t\t\t\"code\": \"'AUDITOR' in auth.role\",\r\n\t\t\t\t\t\t\"explain\": \"限角色为审核\",\r\n\t\t\t\t\t\t\"explain_end\": \"含字段【ip】的记录\"\r\n\t\t\t\t\t}\r\n\t\t\t\t]\r\n\t\t\t}\r\n\t\t},\r\n\t\tcreated() {\r\n\t\t\tfor (var j = 0; j < this.types.length; j++) {\r\n\t\t\t\tlet type = this.types[j].value\r\n\t\t\t\tconsole.log(type);\r\n\t\t\t\tfor (let i = 0; i < this.permissionList.length; i++) {\r\n\t\t\t\t\tlet jsonString = `{\r\n\t\t\t\t\t\t\t\"properties\":{\r\n\t\t\t\t\t\t\t\t\"${this.permissionList[i].field}\":{\r\n\t\t\t\t\t\t\t\t\t\"permission\":{\r\n\t\t\t\t\t\t\t\t\t\t\"${type}\":\"${this.permissionList[i].code}\"\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t}`\r\n\t\t\t\t\tif(!this.permissionList[i].codes) this.permissionList[i].codes = {}\r\n\t\t\t\t\tthis.permissionList[i].codes[type] = JSON.parse(jsonString)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tconsole.log(this.permissionList);\r\n\t\t},\r\n\t\tmounted() {\r\n\t\t\tuni.setStorageSync('uni_id_token', '')\r\n\t\t\tuni.setStorageSync('uni_id_token_expired', '')\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tasync myFn(e) { // {type:'',tableName:'',index,action:'',where:{}}\r\n\t\t\t\tconsole.log('myFun' + JSON.stringify(e));\r\n\t\t\t\te.where = e.where || {}\r\n\t\t\t\te.field = e.field || '_id,state,create_time,text,ip'\r\n\t\t\t\tlet item = this.permissionList[e.index]\r\n\t\t\t\tlet tableName = item.tableName || 'permission-test-' + (e.index + 10)\r\n\t\t\t\tuni.showLoading({\r\n\t\t\t\t\tmask: true\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\tlet hasIp = {}\r\n\t\t\t\tif(e.field.indexOf('ip') != -1){\r\n\t\t\t\t\thasIp = {\"ip\":\"虚拟ip\"+Date.now()};\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconsole.log(\r\n\t\t\t\t\t'表名称：' + tableName +\r\n\t\t\t\t\t',操作：' + this.typeText +\r\n\t\t\t\t\t'\\n 条件：' + JSON.stringify(e.where),\r\n\t\t\t\t\t'\\n field:'+ e.field,\r\n\t\t\t\t\t'\\n data:'+ JSON.stringify({\r\n\t\t\t\t\t\t\t\t\t\"text\": \"数据\" + Date.now(),\r\n\t\t\t\t\t\t\t\t\t...hasIp\r\n\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\r\n\t\t\t\tlet res;\r\n\t\t\t\ttry {\r\n\t\t\t\t\tswitch (e.type) {\r\n\t\t\t\t\t\tcase 'read':\r\n\t\t\t\t\t\t\tres = await db.action(e.action).collection(tableName).where(e.where).field(e.field).get()\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'create':\r\n\t\t\t\t\t\t\tres = await db.action(e.action).collection(tableName)\r\n\t\t\t\t\t\t\t\t.add({\r\n\t\t\t\t\t\t\t\t\t\"text\": \"默认写入的数据\" + Date.now(),\r\n\t\t\t\t\t\t\t\t\t...hasIp\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'update':\r\n\t\t\t\t\t\t\tres = await db.action(e.action).collection(tableName).where(e.where)\r\n\t\t\t\t\t\t\t\t.update({\r\n\t\t\t\t\t\t\t\t\t\"text\": \"更新后的数据\" + Date.now(),\r\n\t\t\t\t\t\t\t\t\t...hasIp\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'delete':\r\n\t\t\t\t\t\t\tres = await db.action(e.action).collection(tableName).where(e.where).remove()\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\tconsole.log('err 未定义事件类型');\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconsole.log(\"res: \",res);\r\n\t\t\t\t\tthis.$refs.alertCode.open(res.result)\r\n\t\t\t\t} catch (err) {\r\n\t\t\t\t\tconsole.log('TODO handle the exception', err);\r\n\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\ttitle: '错误:' + err.message+','+ err.code,\r\n\t\t\t\t\t\tcontent: item.explain +'【'+ this.typeText+'字段'+item.field+'】' + (item.explain_end?item.explain_end:''),\r\n\t\t\t\t\t\tshowCancel: false\r\n\t\t\t\t\t});\r\n\t\t\t\t} finally{\r\n\t\t\t\t\tuni.hideLoading()\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tchangePermission(e) {\r\n\t\t\t\tconsole.log(e, '切换完成');\r\n\t\t\t\tconsole.log(\"this.typeIndex: \",this.typeIndex);\r\n\t\t\t\tthis.currentRole = e.role\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style scoped>\r\n\t.top-view {\r\n\t\tbackground-color: #FFFFFF;\r\n\t\tposition: sticky;\r\n\t\ttop: 0;\r\n\t\t/* #ifdef H5 */\r\n\t\ttop: 44px;\r\n\t\t/* #endif */\r\n\t\tleft: 0;\r\n\t\tz-index: 999;\r\n\t}\r\n\t.top-view .segmented-control {\r\n\t\tpadding: 0 20rpx;\r\n\t}\r\n\t.item {\r\n\t\tpadding: 20rpx 20rpx 0 20rpx;\r\n\t\tborder-bottom: dashed 1px #E9E9EB;\r\n\t}\r\n\t.msg{\r\n\t\tfont-weight: 500;\r\n\t\tfont-size: 16px;\r\n\t}\r\n\t.msg::before{\r\n\t\tcontent:'·';\r\n\t\twidth: 10px;\r\n\t\theight: 10px;\r\n\t\tline-height: 14px;\r\n\t\ttop: 5px;\r\n\t\tposition: relative;\r\n\t\tfont-size: 30px;\r\n\t}\r\n\t.code-box {\r\n\t\tbackground-color: #fffae7;\r\n\t\tpadding: 5px 30rpx;\r\n\t\twidth: 650rpx;\r\n\t}\r\n\r\n\t.code-box text {\r\n\t\tfont-size: 16px !important;\r\n\t\tcolor: #2b8300 !important;\r\n\t}\r\n\r\n\t.code-box .light {\r\n\t\tcolor: #0077cc !important;\r\n\t}\r\n\r\n\t.code-box .light2 {\r\n\t\tcolor: #009891 !important;\r\n\t}\r\n\r\n\t.navigator {\r\n\t\tpadding: 16rpx;\r\n\t\tcolor: #586b95;\r\n\t}\r\n\r\n\t.page {\r\n\t\tpadding-bottom: 100px;\r\n\t\tbackground-color: #FFFFFF;\r\n\t\tfont-size: 14px;\r\n\t}\r\n\r\n\tbutton {\r\n\t\tmargin: 8rpx 16rpx;\r\n\t}\r\n\t\r\n\t\r\n</style>\r\n","import MiniProgramPage from 'E:/web/cooqi/fjywq/pages/clientDB/permission-field-simple/permission-field-simple.vue'\nwx.createPage(MiniProgramPage)"],"names":["uniCloud","uni"],"mappings":"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"}