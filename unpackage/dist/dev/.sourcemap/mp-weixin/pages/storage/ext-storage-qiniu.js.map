{"version":3,"file":"ext-storage-qiniu.js","sources":["pages/storage/ext-storage-qiniu.vue","D:/ruanjian/HBuilderX.3.6.18.20230117/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvc3RvcmFnZS9leHQtc3RvcmFnZS1xaW5pdS52dWU"],"sourcesContent":["<template>\r\n\t<view class=\"content\">\r\n\t\t<view class=\"title\">直接上传文件到扩展存储-七牛云</view>\r\n\t\t<view class=\"tips\">\r\n\t\t\t<text>\r\n\t\t\t\t各个小程序平台运行时，网络相关的 API 在使用前需要配置域名白名单。\r\n\t\t\t</text>\r\n\t\t\t<j-link text=\"参考\" url=\"https://uniapp.dcloud.net.cn/uniCloud/publish.html#useinmp\"></j-link>\r\n\t\t</view>\r\n\t\t<view class=\"btn-list\">\r\n\t\t\t<button type=\"primary\" plain @click=\"chooseImage(false)\">选择文件“后”上传</button>\r\n\t\t\t<text class=\"tips\">先调用uni.chooseImage选完文件/图片/视频后用uni.uploadFile方法上传</text>\r\n\t\t\t<button type=\"primary\" plain @click=\"chooseImage(true)\">上传并设为私有文件</button>\r\n\t\t\t<text class=\"tips\">上传完成后设置为私有文件</text>\r\n\t\t\t<button type=\"primary\" plain @click=\"getTempFileURL()\" v-if=\"privateFileID\">获取私有文件临时下载链接</button>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\texport default {\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tprivateFileID: \"\"\r\n\t\t\t}\r\n\t\t},\r\n\t\tmounted() {},\r\n\t\tmethods: {\r\n\t\t\tchooseImage(isPrivate) {\r\n\t\t\t\tnew Promise((resolve, reject) => {\r\n\t\t\t\t\tuni.chooseImage({\r\n\t\t\t\t\t\tcount: 1,\r\n\t\t\t\t\t\tsuccess: res => {\r\n\t\t\t\t\t\t\tconst path = res.tempFilePaths[0]\r\n\t\t\t\t\t\t\tlet ext\r\n\t\t\t\t\t\t\t// #ifdef H5\r\n\t\t\t\t\t\t\text = res.tempFiles[0].name.split('.').pop()\r\n\t\t\t\t\t\t\tconst options = {\r\n\t\t\t\t\t\t\t\tfilePath: path,\r\n\t\t\t\t\t\t\t\tcloudPath: Date.now() + '.' + ext,\r\n\t\t\t\t\t\t\t\tisPrivate\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tresolve(options)\r\n\t\t\t\t\t\t\t// #endif\r\n\t\t\t\t\t\t\t// #ifndef H5\r\n\t\t\t\t\t\t\tuni.getImageInfo({\r\n\t\t\t\t\t\t\t\tsrc: path,\r\n\t\t\t\t\t\t\t\tsuccess(info) {\r\n\t\t\t\t\t\t\t\t\tconst options = {\r\n\t\t\t\t\t\t\t\t\t\tfilePath: path,\r\n\t\t\t\t\t\t\t\t\t\tcloudPath: Date.now() + '.' + info.type.toLowerCase()\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tresolve(options)\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tfail(err) {\r\n\t\t\t\t\t\t\t\t\treject(new Error(err.errMsg || '未能获取图片类型'))\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t// #endif\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: () => {\r\n\t\t\t\t\t\t\treject(new Error('Fail_Cancel'))\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}).then((options) => {\r\n\t\t\t\t\tthis.uploadFile(options);\r\n\t\t\t\t}).catch((err) => {\r\n\t\t\t\t\tuni.hideLoading()\r\n\t\t\t\t\tconsole.log(err);\r\n\t\t\t\t\tif (err.message !== 'Fail_Cancel') {\r\n\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\tcontent: `图片上传失败，错误信息为：${err.message}`,\r\n\t\t\t\t\t\t\tshowCancel: false\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tasync uploadFile(options) {\r\n\t\t\t\tuni.showLoading({\r\n\t\t\t\t\ttitle: '文件上传中...'\r\n\t\t\t\t})\r\n\t\t\t\tconst uniCloudStorageExtCo = uniCloud.importObject(\"ext-storage-co\", {\r\n\t\t\t\t\tcustomUI: true\r\n\t\t\t\t});\r\n\t\t\t\tconst uploadFileOptionsRes = await uniCloudStorageExtCo.getUploadFileOptions({\r\n\t\t\t\t\tcloudPath: `test/${Date.now()}.jpg`, // 支持自定义目录\r\n\t\t\t\t});\r\n\t\t\t\tconsole.log('uploadFileOptionsRes: ', uploadFileOptionsRes)\r\n\t\t\t\tconst uploadTask = uni.uploadFile({\r\n\t\t\t\t\t...uploadFileOptionsRes.uploadFileOptions, // 上传文件所需参数\r\n\t\t\t\t\tfilePath: options.filePath, // 本地文件路径\r\n\t\t\t\t\tsuccess: async () => {\r\n\t\t\t\t\t\tconst res = {\r\n\t\t\t\t\t\t\tcloudPath: uploadFileOptionsRes.cloudPath, // 文件云端路径\r\n\t\t\t\t\t\t\tfileID: uploadFileOptionsRes.fileID, // 文件ID\r\n\t\t\t\t\t\t\tfileURL: uploadFileOptionsRes.fileURL, // 文件URL（如果是私有权限，则此URL是无法直接访问的）\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\t// 上传成功后的逻辑\r\n\t\t\t\t\t\tconsole.log(res);\r\n\t\t\t\t\t\tif (options.isPrivate) {\r\n\t\t\t\t\t\t\t// 设为私有文件\r\n\t\t\t\t\t\t\tconst uniCloudStorageExtCo = uniCloud.importObject(\"ext-storage-co\", {\r\n\t\t\t\t\t\t\t\tcustomUI: true\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tawait uniCloudStorageExtCo.setFilePrivate({\r\n\t\t\t\t\t\t\t\tfileID: res.fileID\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tthis.privateFileID = res.fileID;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\tcontent: '图片上传成功，fileID为：' + res.fileID,\r\n\t\t\t\t\t\t\tshowCancel: false\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\t// 上传失败后的逻辑\r\n\t\t\t\t\t\tconsole.log(err);\r\n\t\t\t\t\t\tif (err.message !== 'Fail_Cancel') {\r\n\t\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\t\tcontent: `图片上传失败，错误信息为：${err.message}`,\r\n\t\t\t\t\t\t\t\tshowCancel: false\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcomplete: () => {\r\n\t\t\t\t\t\tuni.hideLoading()\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// 监听上传进度\r\n\t\t\t\tuploadTask.onProgressUpdate((res) => {\r\n\t\t\t\t\tconsole.log(\"监听上传进度\", res);\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tasync getTempFileURL() {\r\n\t\t\t\tconst uniCloudStorageExtCo = uniCloud.importObject(\"ext-storage-co\");\r\n\t\t\t\tlet res = await uniCloudStorageExtCo.getTempFileURL({\r\n\t\t\t\t\tfileList: [this.privateFileID]\r\n\t\t\t\t});\r\n\t\t\t\tlet tempFileURL = res.fileList[0].tempFileURL;\r\n\t\t\t\tuni.showModal({\r\n\t\t\t\t\tcontent: '图片临时下载链接为：' + tempFileURL,\r\n\t\t\t\t\tshowCancel: false\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style>\r\n\t.content {\r\n\t\tpadding-bottom: 30px;\r\n\t}\r\n\r\n\t.title {\r\n\t\tfont-weight: bold;\r\n\t\ttext-align: center;\r\n\t\tpadding: 20px 0px;\r\n\t\tfont-size: 20px;\r\n\t}\r\n\r\n\t.tips {\r\n\t\tcolor: #999999;\r\n\t\tfont-size: 14px;\r\n\t\tpadding: 20px 30px;\r\n\t}\r\n\r\n\t.btn-list {\r\n\t\tpadding: 0px 30px;\r\n\t}\r\n\r\n\t.btn-list button {\r\n\t\tmargin-top: 20px;\r\n\t}\r\n\r\n\t.upload-preview {\r\n\t\twidth: 100%;\r\n\t}\r\n</style>","import MiniProgramPage from 'E:/web/cooqi/fjywq/pages/storage/ext-storage-qiniu.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","uniCloud","uniCloudStorageExtCo"],"mappings":"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"}