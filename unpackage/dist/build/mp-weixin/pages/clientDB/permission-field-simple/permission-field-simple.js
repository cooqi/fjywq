"use strict";const e=require("../../../common/vendor.js"),t=e.tr.database(),n={components:{uniNoticeBar:()=>"../../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js",alertCode:()=>"../../../components/alertCode/alertCode.js"},computed:{type(){return this.types[this.typeIndex].value},typeText(){return this.types[this.typeIndex].text}},data:()=>({currentRole:0,types:[{text:"创建",value:"create"},{text:"读取",value:"read"},{text:"更新",value:"update"}],typeIndex:0,permissionList:[{msg:"直接禁止",field:"ip",code:!1,explain:"禁止任何角色",explain_end:"含字段ip的记录，管理员角色除外"},{msg:"需要登陆",field:"ip",code:"auth.uid != null",explain:"禁止未登陆的游客",explain_end:"含字段ip的记录"},{msg:"指定角色",field:"ip",code:"'AUDITOR' in auth.role",explain:"限角色为审核",explain_end:"含字段【ip】的记录"}]}),created(){for(var e=0;e<this.types.length;e++){let t=this.types[e].value;console.log(t);for(let e=0;e<this.permissionList.length;e++){let n=`{\n\t\t\t\t\t\t\t"properties":{\n\t\t\t\t\t\t\t\t"${this.permissionList[e].field}":{\n\t\t\t\t\t\t\t\t\t"permission":{\n\t\t\t\t\t\t\t\t\t\t"${t}":"${this.permissionList[e].code}"\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}`;this.permissionList[e].codes||(this.permissionList[e].codes={}),this.permissionList[e].codes[t]=JSON.parse(n)}}console.log(this.permissionList)},mounted(){e.index.setStorageSync("uni_id_token",""),e.index.setStorageSync("uni_id_token_expired","")},methods:{async myFn(n){console.log("myFun"+JSON.stringify(n)),n.where=n.where||{},n.field=n.field||"_id,state,create_time,text,ip";let i=this.permissionList[n.index],o=i.tableName||"permission-test-"+(n.index+10);e.index.showLoading({mask:!0});let s,a={};-1!=n.field.indexOf("ip")&&(a={ip:"虚拟ip"+Date.now()}),console.log("表名称："+o+",操作："+this.typeText+"\n 条件："+JSON.stringify(n.where),"\n field:"+n.field,"\n data:"+JSON.stringify({text:"数据"+Date.now(),...a}));try{switch(n.type){case"read":s=await t.action(n.action).collection(o).where(n.where).field(n.field).get();break;case"create":s=await t.action(n.action).collection(o).add({text:"默认写入的数据"+Date.now(),...a});break;case"update":s=await t.action(n.action).collection(o).where(n.where).update({text:"更新后的数据"+Date.now(),...a});break;case"delete":s=await t.action(n.action).collection(o).where(n.where).remove();break;default:console.log("err 未定义事件类型")}console.log("res: ",s),this.$refs.alertCode.open(s.result)}catch(r){console.log("TODO handle the exception",r),e.index.showModal({title:"错误:"+r.message+","+r.code,content:i.explain+"【"+this.typeText+"字段"+i.field+"】"+(i.explain_end?i.explain_end:""),showCancel:!1})}finally{e.index.hideLoading()}},changePermission(e){console.log(e,"切换完成"),console.log("this.typeIndex: ",this.typeIndex),this.currentRole=e.role}}};if(!Array){(e.resolveComponent("uniNoticeBar")+e.resolveComponent("uni-segmented-control")+e.resolveComponent("alertCode")+e.resolveComponent("show-code")+e.resolveComponent("set-permission"))()}Math||((()=>"../../../uni_modules/uni-segmented-control/components/uni-segmented-control/uni-segmented-control.js")+(()=>"../../../components/alertCode/alertCode.js")+(()=>"../../../components/show-code/show-code.js")+(()=>"../../../components/set-permission/set-permission.js"))();const i=e._export_sfc(n,[["render",function(t,n,i,o,s,a){return{a:e.p({showIcon:"true",iconType:"info",text:"管理员(admin)拥有任何权限,权限控制对其无效。"}),b:e.o((e=>s.typeIndex=e.currentIndex)),c:e.p({values:s.types.map((({text:e})=>e))}),d:e.sr("alertCode","0e532896-2"),e:e.f(s.permissionList,((t,n,i)=>e.e({a:t.exclude!==a.type},t.exclude!==a.type?e.e({b:e.t(t.msg),c:e.t(n+10),d:"0e532896-3-"+i,e:e.p({codes:t.codes[a.type]}),f:e.t(t.explain),g:e.t(a.typeText),h:e.t(t.explain_end),i:e.t(a.typeText),j:"create"!=a.type},(a.type,{}),{k:e.o((e=>a.myFn({type:a.type,index:n}))),l:[0,1,2].includes(n)},[0,1,2].includes(n)?{m:e.t(a.typeText),n:e.t(t.field),o:e.o((e=>a.myFn({type:a.type,index:n,field:"_id,state,create_time,text"})))}:{}):{}))),f:e.o(a.changePermission)}}],["__scopeId","data-v-0e532896"]]);wx.createPage(i);
