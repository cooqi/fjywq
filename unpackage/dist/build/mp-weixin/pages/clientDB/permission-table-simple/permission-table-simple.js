"use strict";const e=require("../../../common/vendor.js"),t=e.tr.database(),n={components:{uniNoticeBar:()=>"../../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js",alertCode:()=>"../../../components/alertCode/alertCode.js"},computed:{type(){return this.types[this.typeIndex].value},typeText(){return this.types[this.typeIndex].text}},data:()=>({currentRole:0,lll:'"permission":{',types:[{text:"创建",value:"create"},{text:"读取",value:"read"},{text:"更新",value:"update"},{text:"删除",value:"delete"}],typeIndex:0,permissionList:[{msg:"无任何限制",code:!0,explain:"允许任何角色",explain_end:"本表"},{msg:"完全拒绝",code:!1,explain:"禁止任何角色",explain_end:"，管理员角色除外"},{msg:"需要登陆",code:'"auth.uid != null"',explain:"需要登陆后，换句话说限制：未登陆游客"},{msg:"仅限自己创建",code:'"doc.uid == auth.uid"',explain:"只能",explain_end:"自己创建的数据",exclude:"create"},{msg:"表达式限制",code:'"doc.create_time > (now - 60000)"',explain:"只能",explain_end:"1分钟内创建的数据",exclude:"create"},{msg:"限特定角色",code:"\"'AUDITOR' in auth.role\"",explain:"限审核员角色"},{msg:"读取必须带上action",code:"\"'add_view_count' in action\"",explain:"数据操作",explain_end:"请求同时必须同时附带执行一个action云函数，如未触发该action则权限验证失败"}]}),mounted(){e.index.setStorageSync("uni_id_token",""),e.index.setStorageSync("uni_id_token_expired","")},created(){for(var e=0;e<this.types.length;e++){let t=this.types[e].value;for(let e=0;e<this.permissionList.length;e++){let n=`{\n\t\t\t\t\t\t\t"permission":{\n\t\t\t\t\t\t\t\t"${t}":${this.permissionList[e].code}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}`;this.permissionList[e].codes||(this.permissionList[e].codes={}),this.permissionList[e].codes[t]=JSON.parse(n)}}console.log(this.permissionList)},methods:{async myFn(n){console.log("myFun"+JSON.stringify(n)),n.where=n.where||{};let o,i=this.permissionList[n.index],s=i.tableName||"permission-test-"+(n.index+1);e.index.showLoading({mask:!0}),console.log("表名称："+s+"\n 条件："+JSON.stringify(n.where));try{switch(n.type){case"read":if(o=await t.action(n.action).collection(s).where(n.where).get(),0==o.result.data.length)return e.index.showModal({title:"数据为空，请先点击创建数据",showCancel:!1}),!1;break;case"create":o=await t.action(n.action).collection(s).add({text:"默认写入的数据"+Date.now()});break;case"update":o=await t.action(n.action).collection(s).where(n.where).update({text:"更新后的数据"+Date.now()});break;case"delete":o=await t.action(n.action).collection(s).where(n.where).remove();break;default:console.log("err 未定义事件类型")}console.log("res: ",o),this.$refs.alertCode.open(o.result)}catch(a){console.log("TODO handle the exception",a),e.index.showModal({title:"错误:"+a.message+","+a.code,content:i.explain+"【"+this.typeText+"数据】"+(i.explain_end?i.explain_end:""),showCancel:!1})}finally{e.index.hideLoading()}},changePermission(e){console.log(e,"切换完成"),console.log("role: ",e.role),console.log("typeIndex: ",this.typeIndex),this.currentRole=e.role}}};if(!Array){(e.resolveComponent("uniNoticeBar")+e.resolveComponent("uni-segmented-control")+e.resolveComponent("alertCode")+e.resolveComponent("show-code")+e.resolveComponent("set-permission"))()}Math||((()=>"../../../uni_modules/uni-segmented-control/components/uni-segmented-control/uni-segmented-control.js")+(()=>"../../../components/alertCode/alertCode.js")+(()=>"../../../components/show-code/show-code.js")+(()=>"../../../components/set-permission/set-permission.js"))();const o=e._export_sfc(n,[["render",function(t,n,o,i,s,a){return{a:e.p({showIcon:"true",iconType:"info",text:"管理员(admin)拥有任何权限,权限控制对其无效。"}),b:e.o((e=>s.typeIndex=e.currentIndex)),c:e.p({values:s.types.map((({text:e})=>e))}),d:e.sr("alertCode","08e271dc-2"),e:e.f(s.permissionList,((t,n,o)=>e.e({a:t.exclude!==a.type},t.exclude!==a.type?e.e({b:e.t(t.msg),c:e.t(n+1),d:"08e271dc-3-"+o,e:e.p({codes:t.codes[a.type]}),f:e.t(t.explain),g:e.t(a.typeText),h:e.t(t.explain_end),i:3==n&&"add"!=a.type},3==n&&"add"!=a.type?{j:e.o((e=>a.myFn({type:"create",index:n}))),k:e.t(a.typeText),l:e.o((e=>a.myFn({type:a.type,index:n,where:"uid == $env.uid"})))}:{},{m:4==n&&"add"!=a.type},4==n&&"add"!=a.type?{n:e.o((e=>a.myFn({type:"create",index:n}))),o:e.t(a.typeText),p:e.o((e=>a.myFn({type:a.type,index:n,where:"create_time > "+(Date.now()-6e4)})))}:{},{q:e.t(a.typeText),r:"create"!=a.type},(a.type,{}),{s:e.o((e=>a.myFn({type:a.type,index:n}))),t:6==n},6==n?e.e({v:e.t(a.typeText),w:"create"!=a.type},(a.type,{}),{x:e.o((e=>a.myFn({type:a.type,index:n,action:"add_view_count"})))}):{}):{}))),f:e.o(a.changePermission)}}],["__scopeId","data-v-08e271dc"]]);wx.createPage(o);
