"use strict";const e=require("../../../common/vendor.js"),t=e.tr.database(),o={components:{uniNoticeBar:()=>"../../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js"},data:()=>({noticeData:{_id:null},currentRole:0,options:{selfId:"",where:"",role:{index:0}},activeNoticeId:!1,defaultText:"",fields:"data",swipeActionOptions:[{text:"编辑",style:{backgroundColor:"#007aff"}},{text:"删除",style:{backgroundColor:"#dd524d"}}]}),onLoad(){this.getNoticeData()},onReady(){},methods:{tipLogin(){e.index.showModal({content:"未登陆游客不能写留言！可在底部工具条切换成其他角色体验",showCancel:!1,confirmText:"知道了"})},changePermission(e){switch(console.log("role: ",e),this.options.selfId=e.uid,e.index){case 0:this.options.where=`state == 1 && notice_id == "${this.noticeData._id}"`;break;case 1:this.options.where=`state == 1 && notice_id == "${this.noticeData._id}" || user_id._id==$env.uid`;break;case 2:case 3:this.options.where={notice_id:this.noticeData._id}}this.options.role=e,this.currentRole=e.role},async getNoticeData(){let e=await t.action("add_view_count").collection("opendb-notice").doc("65365ac355b3379a66170144").field("data,_id,update_time,view_count").get();console.log("res: ",e),this.noticeData=e.result.data[0],this.options.where=`state == 1 && notice_id == "${this.noticeData._id}"`},async clickIcon(e,t){e?await this.$refs.udb.remove(t._id):(this.defaultText=t.text,this.activeNoticeId=t._id,this.$refs.upDataDialog.open())},updateState(o,i){console.log(o.detail.value,i),e.index.showLoading({mask:!0}),t.collection("opendb-notice-comment").doc(i).update({state:o.detail.value/1}).then((({code:t,message:i})=>{e.index.showToast({title:"已切换为:"+(o.detail.value?"审核通过":"审核中"),icon:"none",duration:3e3}),console.log(t,i)})).catch((({code:e,message:t})=>{console.log(e,t)})).finally((t=>{e.index.hideLoading(),this.$refs.upDataDialog.close()}))},async updateComment(t){if(console.log(t),console.log(this.activeNoticeId),this.defaultText==t)return e.index.showToast({title:"内容未被修改",icon:"none"}),this.$refs.upDataDialog.close(),!1;e.index.showLoading({mask:!0}),await this.$refs.udb.update(this.activeNoticeId,{text:t},{action:"up_comment",toastTitle:"修改成功",success:e=>{const{code:o,message:i}=e;console.log(o,i),this.$refs.udb.dataList.forEach(((e,o)=>{e._id==this.activeNoticeId&&(this.$refs.udb.dataList[o].text=t,1===this.options.role.index&&(this.$refs.udb.dataList[o].state=0))}))},fail:e=>{console.log("err: ",e)},complete:()=>{e.index.hideLoading(),this.$refs.upDataDialog.close()}})},async submitComment(o){if(console.log(o),!o)return e.index.showToast({title:"留言内容不能为空",icon:"none"}),!1;this.$refs.dialog.close(),await t.collection("opendb-notice-comment").add({notice_id:this.noticeData._id,text:o}).then((e=>{console.log(e),this.getNewData()})).catch((({code:t,message:o})=>{"TOKEN_INVALID_ANONYMOUS_USER"==t&&e.index.showModal({content:"未登陆游客不能写留言",showCancel:!1}),"VALIDATION_ERROR"==t&&e.index.showModal({content:o,showCancel:!1}),console.log(t,o)}))},getNewData(){this.$refs.udb.refresh()},getUserImg(e){switch(e){case"admin":return"../../../static/userImg/2.png";case"user":default:return"../../../static/userImg/0.png";case"auditor":return"../../../static/userImg/1.png"}}}};if(!Array){(e.resolveComponent("uniNoticeBar")+e.resolveComponent("uni-icons")+e.resolveComponent("unicloud-db")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup")+e.resolveComponent("uni-section")+e.resolveComponent("uni-list-item")+e.resolveComponent("set-permission"))()}Math||((()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../../components/uni-section/uni-section.js")+(()=>"../../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../../components/set-permission/set-permission.js"))();const i=e._export_sfc(o,[["render",function(t,o,i,n,s,a){return e.e({a:s.noticeData.data},s.noticeData.data?{b:e.p({showIcon:"true",text:s.noticeData.data})}:{},{c:e.t(s.noticeData.view_count),d:e.o((e=>t.$refs.helpPopup.open())),e:e.p({size:"14",color:"#aaaaaa",type:"info"}),f:e.o((e=>s.options.selfId?t.$refs.dialog.open():a.tipLogin())),g:s.noticeData._id},s.noticeData._id?{h:e.w((({data:t,loading:o,error:i,options:n},s,c)=>e.e({a:t.length},t.length?{b:e.f(t,((t,o,i)=>e.e({a:"../../../static/userImg/"+t.user_id[0].nickname+".png",b:e.t(t.user_id[0].nickname),c:e.t(t.text)},n.role.index>1?{d:1==t.state,e:e.o((e=>a.updateState(e,t._id)),t._id)}:{},{f:n.selfId==t.user_id[0]._id||n.role.index>1},n.selfId==t.user_id[0]._id||n.role.index>1?e.e({g:1===n.role.index&&0==t.state},1===n.role.index&&0==t.state?{}:{h:e.o((e=>a.clickIcon(0,t)),t._id),i:"a0bc0762-3-"+c+"-"+i+",a0bc0762-2",j:e.p({color:"#cdcfd4",size:"16",type:"compose"})},{k:e.o((e=>a.clickIcon(1,t)),t._id),l:"a0bc0762-4-"+c+"-"+i+",a0bc0762-2",m:e.p({color:"#cdcfd4",size:"16",type:"trash"})}):{},{n:t._id}))),c:n.role.index>1}:{},{d:c,e:s})),{name:"d",path:"h",vueId:"a0bc0762-2"}),i:e.sr("udb","a0bc0762-2"),j:e.p({options:s.options,"page-data":"replace",collection:"opendb-notice-comment,uni-id-users",field:"user_id{nickname,_id},text,_id,state",where:s.options.where})}:{},{k:e.o(a.submitComment),l:e.p({mode:"input",title:"提交留言",placeholder:"留言内容不能含单词test"}),m:e.sr("dialog","a0bc0762-5"),n:e.p({type:"dialog"}),o:e.o(a.updateComment),p:e.p({mode:"input",value:s.defaultText,title:"更新留言",placeholder:"留言内容不能含单词test"}),q:e.sr("upDataDialog","a0bc0762-7"),r:e.p({type:"dialog"}),s:e.p({title:"demo说明",type:"line"}),t:e.p({title:"发表留言",note:"未登陆用户不能发表留言,你可以尝试切换账号类型为未登陆,发表留言后会被拒绝请求"}),v:e.p({title:"敏感词过滤",note:"发表留言内容含test会被拦截请求"}),w:e.p({title:"编辑/删除留言",note:"限用户编辑或删除自己发表的留言.管理员可以删除/编辑任何人的留言"}),x:e.p({title:"公告的阅读量",note:"1.读取,限登陆用户查看文章阅读量; \\n 2.自增,阅读量自动增加由特殊的云函数add_view_count完成"}),y:e.p({title:"数据查询",note:"完整留言数据,由opendb-notice-comment,uni-id-users连张表,通过foreignKey联查获取"}),z:e.sr("helpPopup","a0bc0762-9"),A:e.p({type:"center"}),B:e.o(a.changePermission)})}],["__scopeId","data-v-a0bc0762"]]);wx.createPage(i);
