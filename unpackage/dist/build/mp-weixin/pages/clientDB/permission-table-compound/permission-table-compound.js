"use strict";const e=require("../../../common/vendor.js"),t=e.tr.database(),n={components:{uniNoticeBar:()=>"../../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js",alertCode:()=>"../../../components/alertCode/alertCode.js"},computed:{type(){return this.types[this.typeIndex].value},typeText(){return this.types[this.typeIndex].text}},created(){for(var e=0;e<this.types.length;e++){let t=this.types[e].value;console.log(t);for(let e=0;e<this.permissionList.length;e++){let n=`{\n\t\t\t\t\t\t\t"permission":{\n\t\t\t\t\t\t\t\t"${t}":"${this.permissionList[e].code}"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}`;this.permissionList[e].codes||(this.permissionList[e].codes={}),this.permissionList[e].codes[t]=JSON.parse(n)}}console.log(this.permissionList)},data:()=>({currentRole:0,types:[{text:"创建",value:"create"},{text:"读取",value:"read"},{text:"更新",value:"update"},{text:"删除",value:"delete"}],typeIndex:0,permissionList:[{msg:"交集表达式",code:"doc.create_time > (now - 60000) && 'AUDITOR' in auth.role",explain:"限1分钟内的数据，“且”角色必须为审核员",exclude:"create"},{msg:"并集表达式",code:"auth.uid != null || 'add_view_count' in action",explain:"限非未登陆的游客，“或”带action",tableName:"permission-test-9"}]}),mounted(){e.index.setStorageSync("uni_id_token",""),e.index.setStorageSync("uni_id_token_expired","")},methods:{async myFn(n){console.log("myFun"+JSON.stringify(n)),n.where=n.where||{};let o,s=this.permissionList[n.index],i=s.tableName||"permission-test-"+(n.index+8);e.index.showLoading({mask:!0}),console.log("表名称："+i+"\n 条件："+JSON.stringify(n.where));try{switch(n.type){case"read":if(o=await t.action(n.action).collection(i).where(n.where).get(),0==o.result.data.length)return e.index.showModal({title:"数据为空，请先点击创建数据",showCancel:!1}),!1;break;case"create":o=await t.action(n.action).collection(i).add({text:"默认写入的数据"+Date.now()});break;case"update":o=await t.action(n.action).collection(i).where(n.where).update({text:"更新后的数据"+Date.now()});break;case"delete":o=await t.action(n.action).collection(i).where(n.where).remove();break;default:console.log("err 未定义事件类型")}console.log("res: ",o),this.$refs.alertCode.open(o.result)}catch(a){console.log("TODO handle the exception",a),e.index.showModal({title:"错误:"+a.message+","+a.code,content:s.explain+"【"+this.typeText+"数据】"+(s.explain_end?s.explain_end:""),showCancel:!1})}finally{e.index.hideLoading()}},changePermission(e){console.log(e,"切换完成"),console.log("this.typeIndex: ",this.typeIndex),this.currentRole=e.role}}};if(!Array){(e.resolveComponent("uniNoticeBar")+e.resolveComponent("uni-segmented-control")+e.resolveComponent("alertCode")+e.resolveComponent("show-code")+e.resolveComponent("set-permission"))()}Math||((()=>"../../../uni_modules/uni-segmented-control/components/uni-segmented-control/uni-segmented-control.js")+(()=>"../../../components/alertCode/alertCode.js")+(()=>"../../../components/show-code/show-code.js")+(()=>"../../../components/set-permission/set-permission.js"))();const o=e._export_sfc(n,[["render",function(t,n,o,s,i,a){return{a:e.p({showIcon:"true",iconType:"info",text:"管理员(admin)拥有任何权限,权限控制对其无效。"}),b:e.o((e=>i.typeIndex=e.currentIndex)),c:e.p({current:i.typeIndex,values:i.types.map((({text:e})=>e))}),d:e.sr("alertCode","47546b9e-2"),e:e.f(i.permissionList,((t,n,o)=>e.e({a:t.exclude!==a.type},t.exclude!==a.type?e.e({b:e.t(t.msg),c:e.t(n+8),d:"47546b9e-3-"+o,e:e.p({codes:t.codes[a.type]}),f:e.t(t.explain),g:e.t(i.types[i.typeIndex].text),h:e.t(t.explain_end),i:0===n&&"create"!=a.type},0===n&&"create"!=a.type?{j:e.o((e=>a.myFn({type:"create",index:n}))),k:e.t(a.typeText),l:e.o((e=>a.myFn({type:"read",index:n,where:"create_time > "+(Date.now()-6e4)})))}:{},{m:e.t(i.types[i.typeIndex].text),n:"create"!=a.type},(a.type,{}),{o:e.o((e=>a.myFn({type:a.type,index:n}))),p:1===n},1===n?{q:e.t(i.types[i.typeIndex].text),r:e.o((e=>a.myFn({type:a.type,index:n,action:"add_view_count"})))}:{}):{}))),f:e.o(a.changePermission)}}],["__scopeId","data-v-47546b9e"]]);wx.createPage(o);
