"use strict";const e=require("../../../common/vendor.js"),n=e.tr.database();let o;const t={components:{uniNoticeBar:()=>"../../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js",alertCode:()=>"../../../components/alertCode/alertCode.js"},data:()=>({currentRole:""}),mounted(){e.index.setStorageSync("uni_id_token",""),e.index.setStorageSync("uni_id_token_expired",""),o=n.collection("permission-test")},onShow(){this.$nextTick((()=>{this.$refs["set-permission"].init(0)}))},methods:{toDemo(){e.index.navigateTo({url:"./permission-demo"})},previewImage(n){e.index.previewImage({urls:[n]})},addFn(){e.index.showLoading({mask:!0}),o.add({nickname:"默认昵称",username:"默认姓名",phone:"18888888888"}).then((n=>{console.log(n),e.index.showModal({content:'成功写入一条数据：\n{ "nickname":"默认昵称",\n "username":"默认姓名",\n "phone":"18888888888" }',showCancel:!1,confirmText:"知道了"})})).catch((n=>{console.log(n),e.index.showModal({title:"未登录游客不能写入数据",content:"请在底部工具条切换其他角色重试",showCancel:!1,confirmText:"知道了"})})).finally((()=>{e.index.hideLoading()}))},removeFn(){e.index.showLoading({mask:!0}),o.remove().then((n=>{console.log(n,"123"),e.index.showModal({content:JSON.stringify(n.result),showCancel:!1,confirmText:"知道了"})})).catch((n=>{console.log(JSON.stringify(n)),e.index.showModal({title:"当前角色没有该权限",content:"管理员角色不受schema限制，请在底部工具条切换为管理员角色重试",showCancel:!1,confirmText:"知道了"})})).finally((()=>{e.index.hideLoading()}))},updateNickname(e){},updateFn(n,t={}){console.log(n),e.index.showLoading({mask:!0}),o.where(t).update(n).then((n=>{console.log(n),e.index.showModal({content:JSON.stringify(n.result),showCancel:!1,confirmText:"知道了"})})).catch((o=>{"nickname"in n?e.index.showModal({title:"被拒绝，普通用户角色，只能更新自己创建的数据。",content:"请在底部工具条切换为审核员角色重试",showCancel:!1,confirmText:"知道了"}):"state"in n?e.index.showModal({title:"当前角色无该操作权限",content:"请在底部工具条切换为审核员角色重试",showCancel:!1,confirmText:"知道了"}):"username"in n?0===Object.keys(t).length?e.index.showModal({title:"根据表级updat权限设置，普通用户角色限更新自己的数据",content:"请在底部工具条切换为审核员角色重试",showCancel:!1,confirmText:"知道了"}):e.index.showModal({title:"被拒绝，更新的数据含字段state==0的数据",content:"请在底部工具条切换为审核员角色，将全部数据的state更新为1后重试",showCancel:!1,confirmText:"知道了"}):e.index.showModal({title:o.message,showCancel:!1,confirmText:"知道了"}),console.log("错误------",o)})).finally((()=>{e.index.hideLoading()}))},getFn(n="uid,username,nickname,state"){e.index.showLoading({mask:!0}),o.field(n).get().then((n=>{console.log(n),n.result.data.length?this.$refs.alertCode.open(n.result.data):e.index.showModal({title:"查询执行成功",content:"但目前数据库为空,\n 请滚动页面找到【创建一条数据】点击后重试!",showCancel:!1,confirmText:"知道了"})})).catch((n=>{console.log(n,"err---"),e.index.showModal({title:"当前角色无权访问含phone字段数据",content:"请在底部工具条切换其他角色重试",showCancel:!1,confirmText:"知道了"})})).finally((()=>{e.index.hideLoading()}))},changePermission(e){console.log(e,"切换完成"),this.currentRole=e.role}}};if(!Array){(e.resolveComponent("alertCode")+e.resolveComponent("uniNoticeBar")+e.resolveComponent("page-head")+e.resolveComponent("uni-section")+e.resolveComponent("show-code")+e.resolveComponent("set-permission"))()}Math||((()=>"../../../components/alertCode/alertCode.js")+(()=>"../../../components/page-head/page-head.js")+(()=>"../../../components/uni-section/uni-section.js")+(()=>"../../../components/show-code/show-code.js")+(()=>"../../../components/set-permission/set-permission.js"))();const i=e._export_sfc(t,[["render",function(n,o,t,i,s,a){return{a:e.sr("alertCode","50ec4991-0"),b:e.p({showIcon:"true",iconType:"info",text:"管理员(admin)拥有任何权限,权限控制对其无效。"}),c:e.o(((...e)=>a.toDemo&&a.toDemo(...e))),d:e.p({title:"表级权限控制",subTitle:"包括增删改查四种权限，分别称为：create、delete、update、read"}),e:e.p({title:"根据true和false控制数据库的相关操作",type:"circle"}),f:e.p({codes:{permission:{read:!0}}}),g:e.o((e=>a.getFn("uid,username,nickname,state"))),h:e.p({codes:{permission:{delete:!1}}}),i:e.o(((...e)=>a.removeFn&&a.removeFn(...e))),j:e.p({title:"根据操作的用户id、角色和权限数组",type:"circle"}),k:e.p({codes:{permission:{create:"auth.uid != null"}}}),l:e.o((e=>a.addFn())),m:e.p({title:"根据数据库中的目标数据记录",type:"circle"}),n:e.p({codes:{permission:{create:"auth.uid==doc.uid || AUDITOR in auth.role || UPDATE_USER_INFO in auth.permission"}}}),o:e.o((e=>a.updateFn({nickname:"新昵称"},"uid == $env.uid"))),p:e.o((e=>a.updateFn({nickname:"新昵称"}))),q:e.p({title:"字段级权限控制"}),r:e.p({title:"修改指定字段需要特殊角色",type:"circle"}),s:e.p({codes:{properties:{state:{permission:{write:"AUDITOR in auth.role"}}}}}),t:e.o((e=>a.updateFn({state:1}))),v:e.p({title:"修改指定字段时,当前记录的某个字段应当满足某种条件",type:"circle"}),w:e.p({codes:{properties:{username:{permission:{write:"doc.state != 0"}}}}}),x:e.o((e=>a.updateFn({username:"新姓名"}))),y:e.o((e=>a.updateFn({username:"新姓名"},"uid == $env.uid"))),z:e.p({title:"控制特殊字段不可读",type:"circle"}),A:e.p({codes:{properties:{phone:{permission:{read:"auth.uid != null"}}}}}),B:e.o((e=>a.getFn("uid,username,nickname,state"))),C:e.o((e=>a.getFn("uid,username,nickname,state,phone"))),D:e.sr("set-permission","50ec4991-17"),E:e.o(a.changePermission)}}],["__scopeId","data-v-50ec4991"]]);wx.createPage(i);
