"use strict";const e=require("../../../../common/vendor.js"),a=require("../mixin/version_add_detail_mixin.js"),t=require("../utils.js"),i=e.tr.database();i.command;const o=t.appVersionListDbName,s={components:{showInfo:()=>"../components/show-info.js"},mixins:[a.addAndDetail],data:()=>({showStableInfo:!1,isStable:!0,originalData:{},detailsState:!0}),async onLoad(e){const a=e.id;this.formDataId=a,await this.getDetail(a),this.isStable=this.formData.stable_publish,this.latestStableData=await this.getLatestVersion(),this.isWGT&&this.rules.min_uni_version.rules.push({required:!0})},methods:{submit(){e.index.showLoading({mask:!0}),this.$refs.form.validate().then((e=>{e.store_list=this.formData.store_list,e.store_list&&e.store_list.forEach((e=>{e.priority=parseFloat(e.priority)})),this.submitForm(e)})).catch((a=>{e.index.hideLoading()}))},async submitForm(a){const t=i.collection(o);t.doc(this.formDataId).update(a).then((async i=>{!this.isStable&&!0===a.stable_publish&&this.latestStableData&&await t.doc(this.latestStableData._id).update({stable_publish:!1}),e.index.showToast({title:"修改成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>e.index.navigateBack()),500)})).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))},getDetail(s){return e.index.showLoading({mask:!0}),i.collection(o).doc(s).field(a.fields).get().then((e=>{const a=e.result.data[0];a&&(this.formData=a,this.originalData=t.deepClone(this.formData))})).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))},deletePackage(){e.index.showModal({title:"提示",content:"是否删除该版本",success:a=>{a.confirm&&(e.index.showLoading({mask:!0}),i.collection(o).doc(this.formDataId).remove().then((()=>{e.index.showToast({title:"删除成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>e.index.navigateBack()),500)})).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()})))}})},async getLatestVersion(){const e={appid:this.formData.appid,type:this.formData.type,stable_publish:!0};this.isWGT||(e.platform=this.formData.platform[0]);return(await i.collection(o).where(e).get()).result.data.find((e=>e.platform.toString()===this.formData.platform.toString()))},cancelEdit(){let a="";!this.isiOS&&this.hasPackage&&(a+="\n将会删除已上传的包"),e.index.showModal({title:"取消修改",content:a,success:e=>{if(e.confirm&&(this.formData=t.deepClone(this.originalData),this.detailsState=!0,this.hasPackage)){let e=[];e.push(this.appFileList.url),this.$request("deleteFile",{fileList:e},{functionName:"upgrade-center"})}}})}}};if(!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("show-info")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../../uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../../uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../../uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../../uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../../uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../../uni-forms/components/uni-forms/uni-forms.js"))();const l=e._export_sfc(s,[["render",function(a,t,i,o,s,l){return e.e({a:e.t(a.type_valuetotext[a.formData.type]),b:!s.isStable},s.isStable?{}:{c:e.o(((...e)=>l.deletePackage&&l.deletePackage(...e)))},{d:e.o((e=>a.formData.appid=e)),e:e.p({disabled:!0,trim:"both",modelValue:a.formData.appid}),f:e.p({name:"appid",label:"AppID",required:!0}),g:e.o((e=>a.formData.name=e)),h:e.p({disabled:!0,trim:"both",modelValue:a.formData.name}),i:e.p({name:"name",label:"应用名称"}),j:e.o((e=>a.formData.title=e)),k:e.p({disabled:s.detailsState,placeholder:"更新标题",modelValue:a.formData.title}),l:e.p({name:"title",label:"更新标题"}),m:s.detailsState,n:e.o((e=>a.binddata("contents",e.detail.value))),o:a.formData.contents,p:e.o((e=>a.formData.contents=e)),q:e.p({name:"contents",label:"更新内容",required:!0}),r:e.o((e=>a.formData.platform=e)),s:e.p({disabled:!0,multiple:!0,localdata:a.platformLocaldata,modelValue:a.formData.platform}),t:e.p({name:"platform",label:"平台",required:!0}),v:e.o((e=>a.formData.version=e)),w:e.p({disabled:!0,placeholder:"当前包版本号，必须大于当前已上线版本号",modelValue:a.formData.version}),x:e.p({name:"version",label:"版本号",required:!0}),y:a.isWGT},a.isWGT?{z:e.o((e=>a.formData.min_uni_version=e)),A:e.p({disabled:s.detailsState,placeholder:"原生App最低版本",modelValue:a.formData.min_uni_version}),B:e.p({content:a.minUniVersionContent}),C:e.p({name:"min_uni_version",label:"原生App最低版本",required:a.isWGT})}:{},{D:!a.isiOS&&!s.detailsState},a.isiOS||s.detailsState?{}:e.e({E:e.o(((...e)=>a.selectFile&&a.selectFile(...e))),F:e.o(a.packageUploadSuccess),G:e.o(a.packageDelete),H:e.o((e=>a.appFileList=e)),I:e.p({"file-extname":a.fileExtname,disabled:a.hasPackage,returnType:"object","file-mediatype":"all",limit:"1",modelValue:a.appFileList}),J:a.hasPackage},a.hasPackage?{K:e.t(Number(a.appFileList.size/1024/1024).toFixed(2))}:{},{L:e.p({label:"上传apk包"})}),{M:e.o((e=>a.formData.url=e)),N:e.p({disabled:s.detailsState,placeholder:"下载链接",maxlength:-1,modelValue:a.formData.url}),O:e.p({name:"url",label:a.isiOS?"AppStore":"下载链接",required:!0}),P:a.isWGT},a.isWGT?{Q:s.detailsState,R:e.o((e=>(a.binddata("is_silently",e.detail.value),a.formData.is_silently=e.detail.value))),S:a.formData.is_silently,T:e.p({top:-80,content:a.silentlyContent}),U:e.p({name:"is_silently",label:"静默更新"})}:{},{V:!a.isiOS},a.isiOS?{}:{W:s.detailsState,X:e.o((e=>(a.binddata("is_mandatory",e.detail.value),a.formData.is_mandatory=e.detail.value))),Y:a.formData.is_mandatory,Z:e.p({width:"230",top:-30,content:a.mandatoryContent}),aa:e.p({name:"is_mandatory",label:"强制更新"})},{ab:s.detailsState||s.isStable,ac:e.o((e=>(a.binddata("stable_publish",e.detail.value),a.formData.stable_publish=e.detail.value))),ad:a.formData.stable_publish,ae:s.isStable},s.isStable?{af:e.p({top:-50,width:"350",content:a.stablePublishContent})}:{ag:e.p({top:-40,content:a.stablePublishContent2})},{ah:e.p({name:"stable_publish",label:"上线发行"}),ai:e.p({format:"yyyy-MM-dd hh:mm:ss",date:a.formData.create_date,threshold:[0,0]}),aj:e.p({name:"create_date",label:"上传时间"}),ak:e.o((e=>a.formData.type=e)),al:e.p({localdata:a.formOptions.type_localdata,modelValue:a.formData.type}),am:e.p({name:"type",label:"安装包类型"}),an:s.detailsState},s.detailsState?{ao:e.o((e=>s.detailsState=!1))}:{},{ap:!s.detailsState},s.detailsState?{}:{aq:e.o(((...e)=>l.submit&&l.submit(...e)))},{ar:!s.detailsState},s.detailsState?{}:{as:e.o(((...e)=>l.cancelEdit&&l.cancelEdit(...e)))},{at:e.sr("form","0dd5880d-0"),av:e.p({value:a.formData,validateTrigger:"bind",labelWidth:a.labelWidth})})}]]);wx.createPage(l);
