"use strict";const e=require("../../../../common/vendor.js"),t=require("../mixin/version_add_detail_mixin.js"),a=require("../utils.js"),i=e.tr.database();i.command;const s=a.appVersionListDbName;const o={components:{showInfo:()=>"../components/show-info.js"},mixins:[t.addAndDetail],data:()=>({latestVersion:"0.0.0",lastVersionId:""}),async onLoad({appid:e,name:t,type:a}){e&&a&&t&&(this.formData={...this.formData,appid:e,name:t,type:a},this.latestStableData=await this.getDetail(e,a),!this.isWGT&&this.latestStableData.length&&this.setFormData("Android"),this.isWGT&&this.rules.min_uni_version.rules.push({required:!0}))},watch:{isiOS(e){e?this.setFormData("iOS"):this.hasPackage?this.formData.url=this.appFileList.url:this.formData.url=""},"formData.platform"(e){this.isWGT&&this.setFormData(e)}},methods:{setFormData(t){e.index.showLoading({mask:!0}),this.latestVersion="0.0.0",this.lastVersionId="";const a=this.getData(this.latestStableData,t)[0];if(a){const{_id:e,version:t,name:i,platform:s,min_uni_version:o,url:n}=a;this.lastVersionId=e,this.latestVersion=t,this.formData.name=i,this.isWGT?this.formData.min_uni_version=o:(delete this.formData.min_uni_version,this.formData.platform=s[0],this.isiOS&&(this.formData.url=n))}else this.isWGT&&(this.formData.min_uni_version="");e.index.hideLoading()},submit(){this.formData.url||!this.isiOS?(e.index.showLoading({mask:!0}),this.$refs.form.validate().then((t=>{if(t.url=this.formData.url,function(e="0",t="0"){e=String(e).split("."),t=String(t).split(".");const a=Math.min(e.length,t.length);let i=0;for(let s=0;s<a;s++){const a=Number(e[s]),o=Number(t[s]);if(a>o){i=1;break}if(a<o){i=-1;break}}if(0===i&&e.length!==t.length){const s=e.length>t.length,o=s?e:t;for(let e=a;e<o.length;e++)if(Number(o[e])>0){i=s?1:-1;break}}return i}(this.latestVersion,t.version)>=0)throw e.index.showModal({content:`版本号必须大于当前已上线版本（${this.latestVersion}）`,showCancel:!1}),new Error("版本号必须大于已上线版本（${this.latestVersion}）");this.isWGT||(t.platform=[t.platform]),(this.isiOS||this.isWGT)&&delete t.store_list,t.store_list&&t.store_list.forEach((e=>{e.priority=parseFloat(e.priority)})),this.submitForm(t)})).catch((t=>{e.index.hideLoading()}))):e.index.showToast({icon:"error",title:"AppStore 链接必填"})},async submitForm(t){t=this.createCenterRecord(t);const a=i.collection(s);let o,n=[];this.isWGT||(n=await this.getDetail(t.appid,t.type,this.createStatQuery(t))),n.length?(t.create_date=Date.now(),o=a.doc(n[0]._id).update(t)):o=a.add(t),o.then((async i=>{t.stable_publish&&this.lastVersionId&&await a.doc(this.lastVersionId).update({stable_publish:!1}),e.index.showToast({title:"新增成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>e.index.navigateBack()),500)})).catch((t=>{e.index.showModal({content:t.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))},getDetail:(a,o,n={})=>(e.index.showLoading({mask:!0}),i.collection(s).where(Object.assign({appid:a,type:o,stable_publish:!0},n)).field(t.fields).get().then((e=>e.result.data)).catch((t=>{e.index.showModal({content:t.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))),getStoreList:e=>i.collection("opendb-app-list").where({appid:e}).get().then((e=>e.result.data[0].store_list||[])),getData:(e=[],t)=>"string"==typeof t?e.filter((e=>e.platform.includes(t))):e.filter((e=>e.platform.toString()===t.toString())),back(){e.index.showModal({title:"取消发布",content:this.hasPackage?"将会删除已上传的包":void 0,success:t=>{if(t.confirm){if(this.hasPackage){let e=[];e.push(this.appFileList.url),this.$request("deleteFile",{fileList:e},{functionName:"upgrade-center"})}e.index.navigateBack()}}})}}};if(!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("show-info")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../../uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../../uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../../uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../../uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../../uni-forms/components/uni-forms/uni-forms.js"))();const n=e._export_sfc(o,[["render",function(t,a,i,s,o,n){return e.e({a:e.t(t.type_valuetotext[t.formData.type]),b:e.o((e=>t.formData.appid=e)),c:e.p({disabled:!0,trim:"both",modelValue:t.formData.appid}),d:e.p({name:"appid",label:"AppID",required:!0}),e:e.o((e=>t.formData.name=e)),f:e.p({disabled:!0,trim:"both",modelValue:t.formData.name}),g:e.p({name:"name",label:"应用名称"}),h:e.o((e=>t.formData.title=e)),i:e.p({placeholder:"更新标题",modelValue:t.formData.title}),j:e.p({name:"title",label:"更新标题"}),k:e.o((e=>t.binddata("contents",e.detail.value))),l:t.formData.contents,m:e.o((e=>t.formData.contents=e)),n:e.p({name:"contents",label:"更新内容",required:!0}),o:e.o((e=>t.formData.platform=e)),p:e.p({multiple:t.isWGT,localdata:t.platformLocaldata,modelValue:t.formData.platform}),q:e.p({name:"platform",label:"平台",required:!0}),r:e.o((e=>t.formData.version=e)),s:e.p({placeholder:"当前包版本号，必须大于当前线上发行版本号",modelValue:t.formData.version}),t:e.p({name:"version",label:"版本号",required:!0}),v:t.isWGT},t.isWGT?{w:e.o((e=>t.formData.min_uni_version=e)),x:e.p({placeholder:"原生App最低版本",modelValue:t.formData.min_uni_version}),y:e.p({content:t.minUniVersionContent}),z:e.p({name:"min_uni_version",label:"原生App最低版本",required:t.isWGT})}:{},{A:!t.isiOS},t.isiOS?{}:e.e({B:e.o(((...e)=>t.selectFile&&t.selectFile(...e))),C:e.o(t.packageUploadSuccess),D:e.o(t.packageDelete),E:e.o((e=>t.appFileList=e)),F:e.p({"file-extname":t.fileExtname,disabled:t.hasPackage,returnType:"object","file-mediatype":"all",limit:"1",modelValue:t.appFileList}),G:t.hasPackage},t.hasPackage?{H:e.t(Number(t.appFileList.size/1024/1024).toFixed(2))}:{},{I:e.p({label:"上传apk包"})}),{J:e.o((e=>t.formData.url=e)),K:e.p({placeholder:"可下载安装包地址",maxlength:-1,modelValue:t.formData.url}),L:e.p({top:-80,content:t.uploadFileContent}),M:e.p({name:"url",label:t.isiOS?"AppStore":"包地址",required:!0}),N:t.isWGT},t.isWGT?{O:e.o((e=>t.binddata("is_silently",e.detail.value))),P:t.formData.is_silently,Q:e.p({top:-80,content:t.silentlyContent}),R:e.p({name:"is_silently",label:"静默更新"})}:{},{S:!t.isiOS},t.isiOS?{}:{T:e.o((e=>t.binddata("is_mandatory",e.detail.value))),U:t.formData.is_mandatory,V:e.p({content:t.mandatoryContent}),W:e.p({name:"is_mandatory",label:"强制更新"})},{X:e.o((e=>t.binddata("stable_publish",e.detail.value))),Y:t.formData.stable_publish,Z:e.p({top:-40,content:t.stablePublishContent2}),aa:e.p({name:"stable_publish",label:"上线发行"}),ab:e.o((e=>t.formData.type=e)),ac:e.p({localdata:t.formOptions.type_localdata,modelValue:t.formData.type}),ad:e.p({name:"type",label:"安装包类型"}),ae:e.o(((...e)=>n.submit&&n.submit(...e))),af:e.o(((...e)=>n.back&&n.back(...e))),ag:e.sr("form","6b55b0d6-0"),ah:e.p({value:t.formData,validateTrigger:"bind",labelWidth:t.labelWidth})})}]]);wx.createPage(n);
